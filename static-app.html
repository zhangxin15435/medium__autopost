<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medium 自动发布系统 - 静态版</title>
    <meta name="description" content="完全免费的Medium文章发布工具，无需登录，立即使用">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .status-banner {
            background: #28a745;
            color: white;
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: bold;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            width: auto;
            margin: 5px;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            background: #f8f9ff;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.info {
            background: #17a2b8;
        }

        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .article-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Medium 自动发布系统</h1>
            <p>完全免费 • 无需登录 • 立即使用</p>
        </div>

        <div class="status-banner">
            ✅ 静态版本 - 无访问限制 - 任何人都可以使用
        </div>

        <!-- Medium API 配置 -->
        <div class="card" style="margin-bottom: 30px;">
            <h2>🔐 Medium 发布配置</h2>
            <div class="tabs">
                <button class="tab active" onclick="switchConfigTab('token')">Integration Token</button>
                <button class="tab" onclick="switchConfigTab('proxy')">CORS 代理</button>
                <button class="tab" onclick="switchConfigTab('extension')">浏览器扩展</button>
            </div>

            <div id="token-config" class="tab-content active">https://cors-anywhere.herokuapp.com/
                <div class="form-group">
                    <label for="mediumToken">Medium Integration Token</label>
                    <input type="password" id="mediumToken" placeholder="输入您的 Medium Integration Token">
                    <small style="color: #666; font-size: 12px;">
                        获取Token: <a href="https://medium.com/me/settings" target="_blank">Medium设置页面</a> → Integration
                        tokens
                    </small>
                </div>
                <div class="form-group">
                    <label for="publicationId">Publication ID (可选)</label>
                    <input type="text" id="publicationId" placeholder="发布到特定Publication的ID">
                </div>
                <button class="btn btn-secondary" onclick="testMediumConnection()">🔍 测试连接</button>
            </div>

            <div id="proxy-config" class="tab-content">
                <div class="form-group">
                    <label for="proxyUrl">CORS 代理地址</label>
                    <input type="url" id="proxyUrl" value="https://cors-anywhere.herokuapp.com/"
                        placeholder="CORS代理服务器地址">
                    <small style="color: #666; font-size: 12px;">
                        推荐代理: cors-anywhere.herokuapp.com 或 api.allorigins.win
                    </small>
                </div>
                <button class="btn btn-secondary" onclick="testProxyConnection()">🔍 测试代理</button>
            </div>

            <div id="extension-config" class="tab-content">
                <div style="padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h4>浏览器扩展模式</h4>
                    <p>通过浏览器扩展或用户脚本来绕过CORS限制：</p>
                    <ol>
                        <li>安装 Tampermonkey 或 Greasemonkey 扩展</li>
                        <li>导入我们提供的用户脚本</li>
                        <li>登录 Medium 网站</li>
                        <li>回到本页面进行发布</li>
                    </ol>
                    <button class="btn btn-secondary" onclick="downloadUserScript()">📥 下载用户脚本</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- 单篇文章创建 -->
            <div class="card">
                <h2>📝 创建新文章</h2>
                <form id="articleForm">
                    <div class="form-group">
                        <label for="title">文章标题 *</label>
                        <input type="text" id="title" name="title" required placeholder="输入文章标题">
                    </div>

                    <div class="form-group">
                        <label for="subtitle">副标题</label>
                        <input type="text" id="subtitle" name="subtitle" placeholder="输入副标题（可选）">
                    </div>

                    <div class="form-group">
                        <label for="content">文章内容 *</label>
                        <textarea id="content" name="content" required placeholder="输入文章内容...支持Markdown格式"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="tags">标签</label>
                        <input type="text" id="tags" name="tags" placeholder="标签1, 标签2, 标签3（用逗号分隔）">
                    </div>

                    <button type="submit" class="btn" id="createBtn">
                        💾 保存文章
                    </button>
                    <button type="button" class="btn" onclick="publishSingleArticle()">
                        🚀 发布到Medium
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="exportMediumFormat()">
                        📤 导出Medium格式
                    </button>
                </form>
            </div>

            <!-- 批量处理 -->
            <div class="card">
                <h2>📁 批量文章处理</h2>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab('upload')">文件上传</button>
                    <button class="tab" onclick="switchTab('template')">下载模板</button>
                </div>

                <div id="upload-tab" class="tab-content active">
                    <div class="file-upload" id="fileUpload">
                        <div>
                            <p>📄 拖拽文件到这里或点击选择</p>
                            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                                支持 CSV, Excel (.xlsx) 格式
                            </p>
                            <div style="margin-top: 10px;">
                                <input type="checkbox" id="enhanceAI" checked>
                                <label for="enhanceAI">使用 AI 增强文章内容</label>
                            </div>
                            <input type="file" id="fileInput" accept=".csv,.xlsx" style="display: none;">
                        </div>
                    </div>

                    <button class="btn" id="processBtn" disabled onclick="processFile()">
                        🔄 处理文件
                    </button>
                    <button class="btn" id="uploadBtn" disabled onclick="uploadToServer()">
                        📤 上传到服务器
                    </button>
                    <button class="btn" id="batchPublishBtn" disabled onclick="batchPublishArticles()">
                        🚀 批量发布到Medium
                    </button>
                </div>

                <div id="template-tab" class="tab-content">
                    <p>下载模板文件，填写文章信息：</p>
                    <button class="btn btn-secondary" onclick="downloadTemplate('csv')">
                        📄 下载 CSV 模板
                    </button>
                    <button class="btn btn-secondary" onclick="downloadTemplate('xlsx')">
                        📊 下载 Excel 模板
                    </button>
                    <div style="margin-top: 15px; font-size: 14px; color: #666;">
                        <p><strong>模板包含列：</strong></p>
                        <p>title, subtitle, content, tags, scheduledTime</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 文章管理 -->
        <div class="card">
            <h2>📚 我的文章</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="loadArticles()">🔄 刷新列表</button>
                <button class="btn btn-secondary" onclick="exportAllArticles()">📦 导出所有文章</button>
                <button class="btn btn-secondary" onclick="clearAllArticles()">🗑️ 清空列表</button>
            </div>
            <div id="articles-container" class="articles-grid">
                <!-- 文章列表将在这里显示 -->
            </div>
        </div>

        <!-- 结果显示 -->
        <div class="card" id="resultCard" style="display: none;">
            <h2>📋 处理结果</h2>
            <div id="resultContent" class="result-box"></div>
        </div>
    </div>

    <!-- 通知 -->
    <div id="notification" class="notification"></div>

    <script>
        // 全局变量
        let articles = JSON.parse(localStorage.getItem('medium-articles') || '[]');
        let currentFile = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function () {
            initializeEventListeners();
            initMediumConfig();
            loadArticles();
            enableBatchPublish();
            showNotification('静态版本加载完成，可以离线使用！', 'success');
        });

        // 事件监听器
        function initializeEventListeners() {
            // 文章表单提交
            document.getElementById('articleForm').addEventListener('submit', handleArticleSubmit);

            // 文件上传
            const fileUpload = document.getElementById('fileUpload');
            const fileInput = document.getElementById('fileInput');

            fileUpload.addEventListener('click', () => fileInput.click());
            fileUpload.addEventListener('dragover', handleDragOver);
            fileUpload.addEventListener('drop', handleFileDrop);
            fileInput.addEventListener('change', handleFileSelect);
        }

        // 文章表单提交
        function handleArticleSubmit(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const article = {
                id: Date.now().toString(),
                title: formData.get('title'),
                subtitle: formData.get('subtitle'),
                content: formData.get('content'),
                tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag),
                createdAt: new Date().toISOString(),
                status: 'saved'
            };

            // 保存到本地存储
            articles.unshift(article);
            localStorage.setItem('medium-articles', JSON.stringify(articles));

            showNotification('文章已保存到本地！', 'success');
            e.target.reset();
            loadArticles();
        }

        // 文件拖拽处理
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        }

        function handleFile(file) {
            if (!file.name.match(/\.(csv|xlsx)$/i)) {
                showNotification('请选择 CSV 或 Excel 文件', 'error');
                return;
            }

            currentFile = file;
            document.getElementById('processBtn').disabled = false;
            document.getElementById('uploadBtn').disabled = false;

            const fileUpload = document.getElementById('fileUpload');
            fileUpload.innerHTML = `
                <div>
                    <p>✅ 已选择文件: ${file.name}</p>
                    <p style="color: #666; font-size: 14px;">
                        文件大小: ${(file.size / 1024).toFixed(1)} KB
                    </p>
                    <button type="button" class="btn btn-secondary" onclick="clearFile()">
                        更换文件
                    </button>
                </div>
            `;
        }

        function clearFile() {
            currentFile = null;
            document.getElementById('processBtn').disabled = true;
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('fileUpload').innerHTML = `
                <div>
                    <p>📄 拖拽文件到这里或点击选择</p>
                    <p style="color: #666; font-size: 14px; margin-top: 10px;">
                        支持 CSV, Excel (.xlsx) 格式
                    </p>
                </div>
            `;
        }

        // 上传文件到服务器
        async function uploadToServer() {
            if (!currentFile) return;

            const btn = document.getElementById('uploadBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> 上传中...';

            try {
                const formData = new FormData();
                formData.append('table', currentFile); // 使用'table'字段名，与API匹配
                formData.append('enhanceWithAI', document.getElementById('enhanceAI')?.checked || false);

                console.log('开始上传文件到服务器:', currentFile.name);

                console.log('发送上传请求...');
                const response = await fetch('/api/batch-upload', {
                    method: 'POST',
                    body: formData
                });

                console.log('收到服务器响应:', response.status);

                // 获取响应文本，不管成功还是失败
                const responseText = await response.text();
                console.log('响应内容:', responseText);

                if (!response.ok) {
                    console.error('上传失败:', response.status, responseText);
                    throw new Error(`服务器错误 (${response.status}): ${responseText}`);
                }

                // 解析JSON响应
                let result;
                try {
                    result = JSON.parse(responseText);
                    console.log('解析后的响应:', result);
                } catch (parseError) {
                    console.error('JSON解析错误:', parseError);
                    throw new Error('无法解析服务器响应: ' + responseText);
                }

                if (result.success) {
                    showNotification(`文件上传成功: ${currentFile.name}`, 'success');
                    showResult(`上传成功! 文件: ${currentFile.name}\n\n${JSON.stringify(result.data, null, 2)}`);
                    clearFile();
                } else {
                    throw new Error(result.error || '上传失败，服务器未返回错误详情');
                }
            } catch (error) {
                console.error('上传错误:', error);
                showNotification('上传失败: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // 处理文件
        function processFile() {
            if (!currentFile) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    // 显示原始文件内容以便调试
                    console.log('文件内容:', e.target.result.substring(0, 500) + '...');

                    let data;
                    if (currentFile.name.endsWith('.csv')) {
                        // 检测文件编码
                        const encoding = detectEncoding(e.target.result);
                        console.log('检测到文件编码:', encoding);

                        data = parseCSV(e.target.result);
                        console.log('解析后的数据:', data.slice(0, 2));
                    } else {
                        showNotification('Excel文件需要专门的解析库，请使用CSV格式', 'error');
                        return;
                    }

                    // 检查是否是特殊格式的内容库文件
                    // 获取数据中的标题行
                    const headers = Object.keys(data[0] || {});
                    const isContentLibraryFile =
                        headers.includes('主题') &&
                        headers.includes('发布') &&
                        headers.includes('提出人') &&
                        headers.includes('发布内容');

                    console.log('是否为内容库格式:', isContentLibraryFile);
                    console.log('检测到的标题:', headers);

                    // 转换为文章格式，支持多种CSV格式
                    const importedArticles = data.map((row, index) => {
                        // 尝试识别不同的列名格式
                        let title, content, tagsField;

                        if (isContentLibraryFile) {
                            // 特殊处理内容库格式
                            title = row['主题'] || `导入文章${index + 1}`;
                            content = row['发布内容'] || row['markdown格式文本'] || '';
                            tagsField = row['标签'] || '';

                            // 调试输出
                            console.log(`处理第${index + 1}行:`, {
                                title: title.substring(0, 30) + '...',
                                contentLength: content.length,
                                tags: tagsField
                            });
                        } else {
                            // 标准格式处理
                            title = row.title || row['标题'] || row['主题'] || `导入文章${index + 1}`;
                            content = row.content || row['内容'] || row['发布内容'] || row['markdown格式文本'] || '';
                            tagsField = row.tags || row['标签'] || '';
                        }

                        const subtitle = row.subtitle || row['副标题'] || '';

                        return {
                            id: Date.now() + index,
                            title: title,
                            subtitle: subtitle,
                            content: content,
                            tags: tagsField ? tagsField.split(/[,，]/).map(tag => tag.trim()).filter(tag => tag) : [],
                            createdAt: new Date().toISOString(),
                            status: 'imported'
                        };
                    });

                    // 添加到文章列表
                    articles = [...importedArticles, ...articles];
                    localStorage.setItem('medium-articles', JSON.stringify(articles));

                    showNotification(`成功导入 ${importedArticles.length} 篇文章！`, 'success');
                    loadArticles();
                    clearFile();

                    // 启用批量发布按钮
                    enableBatchPublish();

                    // 显示结果
                    showResult(`成功导入 ${importedArticles.length} 篇文章：\n\n${importedArticles.map(a => `- ${a.title}`).join('\n')}`);

                } catch (error) {
                    console.error('文件解析错误:', error);
                    // 显示更详细的错误信息
                    showNotification('文件解析失败: ' + error.message + '。请检查文件格式是否正确，或尝试另存为UTF-8编码的CSV文件。', 'error');

                    // 尝试显示部分文件内容以便调试
                    try {
                        const content = e.target.result.substring(0, 200);
                        showResult(`解析失败。文件前200个字符:\n${content}`);
                    } catch (e) {
                        showResult('无法显示文件内容');
                    }
                }
            };

            // 尝试使用不同的编码读取文件
            try {
                // 首先尝试使用UTF-8读取
                reader.readAsText(currentFile, 'UTF-8');
            } catch (e) {
                console.error('UTF-8读取失败，尝试其他编码', e);
                try {
                    // 如果失败，尝试使用GBK/GB18030读取（常见中文编码）
                    reader.readAsText(currentFile, 'GBK');
                } catch (e2) {
                    // 最后回退到默认编码
                    reader.readAsText(currentFile);
                }
            }
        }

        // 检测文本编码
        function detectEncoding(text) {
            // 检查是否有BOM标记
            if (text.charCodeAt(0) === 0xFEFF) {
                return 'UTF-8 with BOM';
            }

            // 检查是否有常见的中文字符
            const hasChineseChars = /[\u4E00-\u9FFF]/.test(text);

            // 检查是否有可能的编码问题（乱码特征）
            const hasPossibleEncodingIssues = /[\uFFFD\u0000-\u0008\u000B-\u000C\u000E-\u001F]/.test(text);

            if (hasChineseChars && !hasPossibleEncodingIssues) {
                return 'UTF-8 (正常)';
            } else if (hasChineseChars && hasPossibleEncodingIssues) {
                return '可能存在编码问题';
            } else {
                return 'ASCII或其他编码';
            }
        }

        // 超级增强版CSV解析器，支持各种格式和编码问题
        function parseCSV(csvText) {
            console.log('开始解析CSV...');

            // 处理可能的BOM
            if (csvText.charCodeAt(0) === 0xFEFF) {
                csvText = csvText.slice(1);
            }

            // 处理不同的行结束符
            csvText = csvText.replace(/\r\n|\r/g, '\n');

            const lines = csvText.split('\n').filter(line => line.trim());
            console.log(`CSV共有 ${lines.length} 行数据`);

            if (lines.length < 1) throw new Error('CSV文件为空');

            // 尝试检测分隔符
            const firstLine = lines[0];
            let separator = ',';
            const commaCount = (firstLine.match(/,/g) || []).length;
            const tabCount = (firstLine.match(/\t/g) || []).length;
            const semicolonCount = (firstLine.match(/;/g) || []).length;

            if (tabCount > commaCount && tabCount > semicolonCount) {
                separator = '\t';
                console.log('检测到制表符分隔的CSV');
            } else if (semicolonCount > commaCount && semicolonCount > tabCount) {
                separator = ';';
                console.log('检测到分号分隔的CSV');
            } else {
                console.log('使用默认逗号分隔符');
            }

            // 超级解析CSV行，处理各种边缘情况
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                let lastNonSpaceChar = '';

                // 处理空行
                if (!line.trim()) {
                    return [];
                }

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            // 转义的引号
                            current += '"';
                            i++; // 跳过下一个引号
                        } else if (inQuotes && (nextChar === separator || nextChar === undefined || nextChar === '\r' || nextChar === '\n')) {
                            // 引号结束，后面是分隔符或行尾
                            inQuotes = false;
                        } else if (!inQuotes && (lastNonSpaceChar === '' || lastNonSpaceChar === separator)) {
                            // 引号开始，前面是行首或分隔符
                            inQuotes = true;
                        } else {
                            // 字段中的引号
                            current += char;
                        }
                    } else if ((char === separator) && !inQuotes) {
                        // 字段分隔符
                        result.push(current.trim());
                        current = '';
                        lastNonSpaceChar = separator;
                    } else {
                        current += char;
                        if (char.trim() !== '') {
                            lastNonSpaceChar = char;
                        }
                    }
                }

                // 添加最后一个字段
                result.push(current.trim());

                return result;
            }

            const headers = parseCSVLine(lines[0]);
            console.log('识别到的标题行:', headers);
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue; // 跳过空行

                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }

            return data;
        }

        // 切换标签页
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // 下载模板
        function downloadTemplate(format) {
            const csvContent = `主题,副标题,发布内容,标签
"示例文章标题","示例副标题","这是文章内容...","技术,编程,自动化"
"第二篇文章","副标题2","更多内容...","教程,指南"`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `medium_articles_template.${format}`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification(`${format.toUpperCase()} 模板下载完成`, 'success');
        }

        // 加载文章列表
        function loadArticles() {
            const container = document.getElementById('articles-container');

            if (articles.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">暂无文章，创建您的第一篇文章吧！</p>';
                return;
            }

            container.innerHTML = articles.map(article => `
                <div class="article-card">
                    <div style="font-weight: 600; margin-bottom: 10px;">${article.title}</div>
                    <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                        状态: ${getStatusText(article.status)} | 
                        创建: ${new Date(article.createdAt).toLocaleString()}
                    </div>
                    <div style="font-size: 14px; margin-bottom: 15px;">
                        ${article.content.substring(0, 100)}${article.content.length > 100 ? '...' : ''}
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" style="width: auto; margin: 0;" onclick="editArticle('${article.id}')">
                            ✏️ 编辑
                        </button>
                        <button class="btn btn-secondary" style="width: auto; margin: 0;" onclick="publishToMedium('${article.id}')">
                            🚀 发布到Medium
                        </button>
                        <button class="btn btn-secondary" style="width: auto; margin: 0;" onclick="exportSingle('${article.id}')">
                            📤 导出
                        </button>
                        <button class="btn btn-secondary" style="width: auto; margin: 0;" onclick="deleteArticle('${article.id}')">
                            🗑️ 删除
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'saved': '已保存',
                'imported': '已导入',
                'exported': '已导出',
                'published': '已发布'
            };
            return statusMap[status] || status;
        }

        // 编辑文章
        function editArticle(articleId) {
            const article = articles.find(a => a.id == articleId);
            if (!article) return;

            document.getElementById('title').value = article.title;
            document.getElementById('subtitle').value = article.subtitle;
            document.getElementById('content').value = article.content;
            document.getElementById('tags').value = article.tags.join(', ');

            // 删除原文章
            articles = articles.filter(a => a.id != articleId);
            localStorage.setItem('medium-articles', JSON.stringify(articles));
            loadArticles();

            showNotification('文章已加载到编辑器', 'info');
        }

        // 导出单篇文章
        function exportSingle(articleId) {
            const article = articles.find(a => a.id == articleId);
            if (!article) return;

            const content = formatForMedium(article);
            downloadText(content, `${article.title}.txt`);
            showNotification('文章已导出为Medium格式', 'success');
        }

        // 删除文章
        function deleteArticle(articleId) {
            if (!confirm('确定要删除这篇文章吗？')) return;

            articles = articles.filter(a => a.id != articleId);
            localStorage.setItem('medium-articles', JSON.stringify(articles));
            loadArticles();
            showNotification('文章已删除', 'success');
        }

        // 导出所有文章
        function exportAllArticles() {
            if (articles.length === 0) {
                showNotification('没有文章可导出', 'error');
                return;
            }

            const allContent = articles.map(article => {
                return `${'='.repeat(50)}\n标题: ${article.title}\n${'='.repeat(50)}\n\n${formatForMedium(article)}\n\n`;
            }).join('\n');

            downloadText(allContent, 'medium-articles-export.txt');
            showNotification(`已导出 ${articles.length} 篇文章`, 'success');
        }

        // 清空所有文章
        function clearAllArticles() {
            if (!confirm('确定要清空所有文章吗？此操作不可恢复！')) return;

            articles = [];
            localStorage.setItem('medium-articles', JSON.stringify(articles));
            loadArticles();
            showNotification('所有文章已清空', 'success');
        }

        // 导出Medium格式
        function exportMediumFormat() {
            const title = document.getElementById('title').value;
            const subtitle = document.getElementById('subtitle').value;
            const content = document.getElementById('content').value;
            const tags = document.getElementById('tags').value;

            if (!title || !content) {
                showNotification('请填写标题和内容', 'error');
                return;
            }

            const article = { title, subtitle, content, tags: tags.split(',').map(t => t.trim()) };
            const formattedContent = formatForMedium(article);

            downloadText(formattedContent, `${title}.txt`);
            showNotification('Medium格式文件已下载', 'success');
        }

        // 格式化为Medium格式
        function formatForMedium(article) {
            let content = `# ${article.title}\n\n`;

            if (article.subtitle) {
                content += `## ${article.subtitle}\n\n`;
            }

            content += article.content;

            if (article.tags && article.tags.length > 0) {
                content += `\n\n---\n\n**标签**: ${article.tags.join(', ')}`;
            }

            return content;
        }

        // 下载文本文件
        function downloadText(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 显示结果
        function showResult(content) {
            const resultCard = document.getElementById('resultCard');
            const resultContent = document.getElementById('resultContent');

            resultContent.textContent = content;
            resultCard.style.display = 'block';
            resultCard.scrollIntoView({ behavior: 'smooth' });
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ============== Medium 发布功能 ==============

        // 配置管理
        let mediumConfig = {
            token: localStorage.getItem('medium-token') || '',
            publicationId: localStorage.getItem('medium-publication') || '',
            proxyUrl: localStorage.getItem('medium-proxy') || 'https://cors-anywhere.herokuapp.com/',
            mode: localStorage.getItem('medium-mode') || 'token' // token, proxy, extension
        };

        // 初始化配置
        function initMediumConfig() {
            document.getElementById('mediumToken').value = mediumConfig.token;
            document.getElementById('publicationId').value = mediumConfig.publicationId;
            document.getElementById('proxyUrl').value = mediumConfig.proxyUrl;
        }

        // 保存配置
        function saveMediumConfig() {
            mediumConfig.token = document.getElementById('mediumToken').value;
            mediumConfig.publicationId = document.getElementById('publicationId').value;
            mediumConfig.proxyUrl = document.getElementById('proxyUrl').value;

            localStorage.setItem('medium-token', mediumConfig.token);
            localStorage.setItem('medium-publication', mediumConfig.publicationId);
            localStorage.setItem('medium-proxy', mediumConfig.proxyUrl);
            localStorage.setItem('medium-mode', mediumConfig.mode);
        }

        // 切换配置标签
        function switchConfigTab(tabName) {
            document.querySelectorAll('#token-config, #proxy-config, #extension-config').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-config').classList.add('active');

            mediumConfig.mode = tabName;
            saveMediumConfig();
        }

        // 测试Medium连接
        async function testMediumConnection() {
            const token = document.getElementById('mediumToken').value;
            if (!token) {
                showNotification('请输入 Medium Token', 'error');
                return;
            }

            try {
                const response = await fetch('https://api.medium.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showNotification(`连接成功！用户: ${data.data.username}`, 'success');
                    saveMediumConfig();
                } else {
                    showNotification('Token验证失败，请检查Token是否正确', 'error');
                }
            } catch (error) {
                showNotification('连接失败: ' + error.message, 'error');
            }
        }

        // 测试代理连接
        async function testProxyConnection() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            if (!proxyUrl) {
                showNotification('请输入代理地址', 'error');
                return;
            }

            try {
                const testUrl = proxyUrl + 'https://api.medium.com/v1/me';
                const response = await fetch(testUrl);

                if (response.status === 401) {
                    showNotification('代理连接正常（需要Token验证）', 'success');
                } else if (response.ok) {
                    showNotification('代理连接成功', 'success');
                } else {
                    showNotification('代理测试失败', 'error');
                }
                saveMediumConfig();
            } catch (error) {
                showNotification('代理连接失败: ' + error.message, 'error');
            }
        }

        // 下载用户脚本
        function downloadUserScript() {
            const userScript = `// ==UserScript==
// @name         Medium Auto Publisher Helper
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  Medium自动发布辅助脚本
// @author       您
// @match        https://medium.com/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';
    
    // 暴露Medium发布函数到全局
    window.publishToMediumDirect = async function(article) {
        try {
            // 这里实现直接发布逻辑
            console.log('发布文章:', article.title);
            return { success: true, url: 'https://medium.com/@username/article-url' };
        } catch (error) {
            return { success: false, error: error.message };
        }
    };
    
    console.log('Medium发布辅助脚本已加载');
})();`;

            downloadText(userScript, 'medium-publisher.user.js');
            showNotification('用户脚本已下载', 'success');
        }

        // 发布单篇文章到Medium
        async function publishSingleArticle() {
            const title = document.getElementById('title').value;
            const subtitle = document.getElementById('subtitle').value;
            const content = document.getElementById('content').value;
            const tags = document.getElementById('tags').value;

            if (!title || !content) {
                showNotification('请填写标题和内容', 'error');
                return;
            }

            const article = {
                title,
                subtitle,
                content,
                tags: tags.split(',').map(t => t.trim()).filter(t => t)
            };

            await publishArticleToMedium(article);
        }

        // 发布单个文章（从列表）
        async function publishToMedium(articleId) {
            const article = articles.find(a => a.id == articleId);
            if (!article) return;

            await publishArticleToMedium(article);
        }

        // 批量发布文章
        async function batchPublishArticles() {
            if (articles.length === 0) {
                showNotification('没有文章可发布', 'error');
                return;
            }

            if (!confirm(`确定要发布 ${articles.length} 篇文章到Medium吗？`)) {
                return;
            }

            const publishBtn = document.getElementById('batchPublishBtn');
            publishBtn.disabled = true;
            publishBtn.innerHTML = '<span class="loading"></span> 发布中...';

            let successCount = 0;
            let failureCount = 0;
            const results = [];

            for (let i = 0; i < articles.length; i++) {
                const article = articles[i];
                showNotification(`正在发布: ${article.title} (${i + 1}/${articles.length})`, 'info');

                try {
                    const result = await publishArticleToMedium(article, false);
                    if (result.success) {
                        successCount++;
                        results.push(`✅ ${article.title}: ${result.url}`);

                        // 更新文章状态
                        article.status = 'published';
                        article.publishedUrl = result.url;
                        article.publishedAt = new Date().toISOString();
                    } else {
                        failureCount++;
                        results.push(`❌ ${article.title}: ${result.error}`);
                    }
                } catch (error) {
                    failureCount++;
                    results.push(`❌ ${article.title}: ${error.message}`);
                }

                // 发布间隔，避免频率限制
                if (i < articles.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }

            // 保存更新后的文章列表
            localStorage.setItem('medium-articles', JSON.stringify(articles));
            loadArticles();

            // 显示结果
            const resultText = `批量发布完成！\n成功: ${successCount} 篇\n失败: ${failureCount} 篇\n\n详细结果:\n${results.join('\n')}`;
            showResult(resultText);
            showNotification(`批量发布完成！成功 ${successCount} 篇，失败 ${failureCount} 篇`, successCount > 0 ? 'success' : 'error');

            publishBtn.disabled = false;
            publishBtn.innerHTML = '🚀 批量发布到Medium';
        }

        // 核心发布函数
        async function publishArticleToMedium(article, showNotifications = true) {
            saveMediumConfig(); // 确保配置是最新的

            if (!mediumConfig.token && mediumConfig.mode === 'token') {
                if (showNotifications) showNotification('请先配置 Medium Token', 'error');
                return { success: false, error: 'Missing Medium Token' };
            }

            try {
                let result;

                switch (mediumConfig.mode) {
                    case 'token':
                        result = await publishViaAPI(article);
                        break;
                    case 'proxy':
                        result = await publishViaProxy(article);
                        break;
                    case 'extension':
                        result = await publishViaExtension(article);
                        break;
                    default:
                        throw new Error('未知的发布模式');
                }

                if (result.success && showNotifications) {
                    showNotification(`文章发布成功！`, 'success');
                }

                return result;

            } catch (error) {
                if (showNotifications) {
                    showNotification(`发布失败: ${error.message}`, 'error');
                }
                return { success: false, error: error.message };
            }
        }

        // 通过官方API发布
        async function publishViaAPI(article) {
            const authorId = await getMediumAuthorId();
            if (!authorId) {
                throw new Error('无法获取作者ID');
            }

            const endpoint = mediumConfig.publicationId
                ? `https://api.medium.com/v1/publications/${mediumConfig.publicationId}/posts`
                : `https://api.medium.com/v1/users/${authorId}/posts`;

            const payload = {
                title: article.title,
                content: formatContentForMedium(article),
                contentFormat: 'markdown',
                publishStatus: 'public',
                tags: article.tags || []
            };

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${mediumConfig.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(`API请求失败: ${response.status} - ${error}`);
            }

            const data = await response.json();
            return {
                success: true,
                url: data.data.url,
                id: data.data.id
            };
        }

        // 通过CORS代理发布
        async function publishViaProxy(article) {
            const proxyEndpoint = mediumConfig.proxyUrl + 'https://api.medium.com/v1/me';

            // 首先获取用户信息
            const userResponse = await fetch(proxyEndpoint, {
                headers: {
                    'Authorization': `Bearer ${mediumConfig.token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!userResponse.ok) {
                throw new Error('代理认证失败');
            }

            const userData = await userResponse.json();
            const authorId = userData.data.id;

            // 发布文章
            const publishEndpoint = mediumConfig.proxyUrl + `https://api.medium.com/v1/users/${authorId}/posts`;

            const payload = {
                title: article.title,
                content: formatContentForMedium(article),
                contentFormat: 'markdown',
                publishStatus: 'public',
                tags: article.tags || []
            };

            const response = await fetch(publishEndpoint, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${mediumConfig.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(`代理发布失败: ${response.status} - ${error}`);
            }

            const data = await response.json();
            return {
                success: true,
                url: data.data.url,
                id: data.data.id
            };
        }

        // 通过浏览器扩展发布
        async function publishViaExtension(article) {
            if (typeof window.publishToMediumDirect === 'function') {
                return await window.publishToMediumDirect(article);
            } else {
                throw new Error('浏览器扩展未安装或未正确配置');
            }
        }

        // 获取Medium作者ID
        async function getMediumAuthorId() {
            try {
                const response = await fetch('https://api.medium.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${mediumConfig.token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.data.id;
                }
            } catch (error) {
                console.error('获取作者ID失败:', error);
            }
            return null;
        }

        // 格式化文章内容为Medium格式
        function formatContentForMedium(article) {
            let content = '';

            if (article.subtitle) {
                content += `## ${article.subtitle}\n\n`;
            }

            content += article.content;

            return content;
        }

        // 启用批量发布按钮
        function enableBatchPublish() {
            const batchBtn = document.getElementById('batchPublishBtn');
            if (batchBtn && articles.length > 0) {
                batchBtn.disabled = false;
            }
        }

        // 定期保存提醒
        setInterval(() => {
            if (articles.length > 0) {
                console.log(`📚 本地已保存 ${articles.length} 篇文章`);
            }
        }, 30000);


    </script>
</body>

</html>