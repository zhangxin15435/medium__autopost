<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medium è‡ªåŠ¨å‘å¸ƒç³»ç»Ÿ - é™æ€ç‰ˆ</title>
    <meta name="description" content="å®Œå…¨å…è´¹çš„Mediumæ–‡ç« å‘å¸ƒå·¥å…·ï¼Œæ— éœ€ç™»å½•ï¼Œç«‹å³ä½¿ç”¨">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .status-banner {
            background: #28a745;
            color: white;
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: bold;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            width: auto;
            margin: 5px;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            background: #f8f9ff;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.info {
            background: #17a2b8;
        }

        .articles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .article-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Medium è‡ªåŠ¨å‘å¸ƒç³»ç»Ÿ</h1>
            <p>å®Œå…¨å…è´¹ â€¢ æ— éœ€ç™»å½• â€¢ ç«‹å³ä½¿ç”¨</p>
        </div>

        <div class="status-banner">
            âœ… é™æ€ç‰ˆæœ¬ - æ— è®¿é—®é™åˆ¶ - ä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨
        </div>

        <!-- Medium API é…ç½® -->
        <div class="card" style="margin-bottom: 30px;">
            <h2>ğŸ” Medium å‘å¸ƒé…ç½®</h2>
            <div class="tabs">
                <button class="tab active" onclick="switchConfigTab('token')">Integration Token</button>
                <button class="tab" onclick="switchConfigTab('proxy')">CORS ä»£ç†</button>
                <button class="tab" onclick="switchConfigTab('extension')">æµè§ˆå™¨æ‰©å±•</button>
            </div>

            <div id="token-config" class="tab-content active">https://cors-anywhere.herokuapp.com/
                <div class="form-group">
                    <label for="mediumToken">Medium Integration Token</label>
                    <input type="password" id="mediumToken" placeholder="è¾“å…¥æ‚¨çš„ Medium Integration Token">
                    <small style="color: #666; font-size: 12px;">
                        è·å–Token: <a href="https://medium.com/me/settings" target="_blank">Mediumè®¾ç½®é¡µé¢</a> â†’ Integration
                        tokens
                    </small>
                </div>
                <div class="form-group">
                    <label for="publicationId">Publication ID (å¯é€‰)</label>
                    <input type="text" id="publicationId" placeholder="å‘å¸ƒåˆ°ç‰¹å®šPublicationçš„ID">
                </div>
                <button class="btn btn-secondary" onclick="testMediumConnection()">ğŸ” æµ‹è¯•è¿æ¥</button>
            </div>

            <div id="proxy-config" class="tab-content">
                <div class="form-group">
                    <label for="proxyUrl">CORS ä»£ç†åœ°å€</label>
                    <input type="url" id="proxyUrl" value="https://cors-anywhere.herokuapp.com/"
                        placeholder="CORSä»£ç†æœåŠ¡å™¨åœ°å€">
                    <small style="color: #666; font-size: 12px;">
                        æ¨èä»£ç†: cors-anywhere.herokuapp.com æˆ– api.allorigins.win
                    </small>
                </div>
                <button class="btn btn-secondary" onclick="testProxyConnection()">ğŸ” æµ‹è¯•ä»£ç†</button>
            </div>

            <div id="extension-config" class="tab-content">
                <div style="padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h4>æµè§ˆå™¨æ‰©å±•æ¨¡å¼</h4>
                    <p>é€šè¿‡æµè§ˆå™¨æ‰©å±•æˆ–ç”¨æˆ·è„šæœ¬æ¥ç»•è¿‡CORSé™åˆ¶ï¼š</p>
                    <ol>
                        <li>å®‰è£… Tampermonkey æˆ– Greasemonkey æ‰©å±•</li>
                        <li>å¯¼å…¥æˆ‘ä»¬æä¾›çš„ç”¨æˆ·è„šæœ¬</li>
                        <li>ç™»å½• Medium ç½‘ç«™</li>
                        <li>å›åˆ°æœ¬é¡µé¢è¿›è¡Œå‘å¸ƒ</li>
                    </ol>
                    <button class="btn btn-secondary" onclick="downloadUserScript()">ğŸ“¥ ä¸‹è½½ç”¨æˆ·è„šæœ¬</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- å•ç¯‡æ–‡ç« åˆ›å»º -->
            <div class="card">
                <h2>ğŸ“ åˆ›å»ºæ–°æ–‡ç« </h2>
                <form id="articleForm">
                    <div class="form-group">
                        <label for="title">æ–‡ç« æ ‡é¢˜ *</label>
                        <input type="text" id="title" name="title" required placeholder="è¾“å…¥æ–‡ç« æ ‡é¢˜">
                    </div>

                    <div class="form-group">
                        <label for="subtitle">å‰¯æ ‡é¢˜</label>
                        <input type="text" id="subtitle" name="subtitle" placeholder="è¾“å…¥å‰¯æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰">
                    </div>

                    <div class="form-group">
                        <label for="content">æ–‡ç« å†…å®¹ *</label>
                        <textarea id="content" name="content" required placeholder="è¾“å…¥æ–‡ç« å†…å®¹...æ”¯æŒMarkdownæ ¼å¼"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="tags">æ ‡ç­¾</label>
                        <input type="text" id="tags" name="tags" placeholder="æ ‡ç­¾1, æ ‡ç­¾2, æ ‡ç­¾3ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰">
                    </div>

                    <button type="submit" class="btn" id="createBtn">
                        ğŸ’¾ ä¿å­˜æ–‡ç« 
                    </button>
                    <button type="button" class="btn" onclick="publishSingleArticle()">
                        ğŸš€ å‘å¸ƒåˆ°Medium
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="exportMediumFormat()">
                        ğŸ“¤ å¯¼å‡ºMediumæ ¼å¼
                    </button>
                </form>
            </div>

            <!-- æ‰¹é‡å¤„ç† -->
            <div class="card">
                <h2>ğŸ“ æ‰¹é‡æ–‡ç« å¤„ç†</h2>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab('upload')">æ–‡ä»¶ä¸Šä¼ </button>
                    <button class="tab" onclick="switchTab('template')">ä¸‹è½½æ¨¡æ¿</button>
                </div>

                <div id="upload-tab" class="tab-content active">
                    <div class="file-upload" id="fileUpload">
                        <div>
                            <p>ğŸ“„ æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
                            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                                æ”¯æŒ CSV, Excel (.xlsx) æ ¼å¼
                            </p>
                            <div style="margin-top: 10px;">
                                <input type="checkbox" id="enhanceAI" checked>
                                <label for="enhanceAI">ä½¿ç”¨ AI å¢å¼ºæ–‡ç« å†…å®¹</label>
                            </div>
                            <input type="file" id="fileInput" accept=".csv,.xlsx" style="display: none;">
                        </div>
                    </div>

                    <button class="btn" id="processBtn" disabled onclick="processFile()">
                        ğŸ”„ å¤„ç†æ–‡ä»¶
                    </button>
                    <button class="btn" id="uploadBtn" disabled onclick="uploadToServer()">
                        ğŸ“¤ ä¸Šä¼ åˆ°æœåŠ¡å™¨
                    </button>
                    <button class="btn" id="batchPublishBtn" disabled onclick="batchPublishArticles()">
                        ğŸš€ æ‰¹é‡å‘å¸ƒåˆ°Medium
                    </button>
                </div>

                <div id="template-tab" class="tab-content">
                    <p>ä¸‹è½½æ¨¡æ¿æ–‡ä»¶ï¼Œå¡«å†™æ–‡ç« ä¿¡æ¯ï¼š</p>
                    <button class="btn btn-secondary" onclick="downloadTemplate('csv')">
                        ğŸ“„ ä¸‹è½½ CSV æ¨¡æ¿
                    </button>
                    <button class="btn btn-secondary" onclick="downloadTemplate('xlsx')">
                        ğŸ“Š ä¸‹è½½ Excel æ¨¡æ¿
                    </button>
                    <div style="margin-top: 15px; font-size: 14px; color: #666;">
                        <p><strong>æ¨¡æ¿åŒ…å«åˆ—ï¼š</strong></p>
                        <p>title, subtitle, content, tags, scheduledTime</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–‡ç« ç®¡ç† -->
        <div class="card">
            <h2>ğŸ“š æˆ‘çš„æ–‡ç« </h2>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="loadArticles()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                <button class="btn btn-secondary" onclick="exportAllArticles()">ğŸ“¦ å¯¼å‡ºæ‰€æœ‰æ–‡ç« </button>
                <button class="btn btn-secondary" onclick="clearAllArticles()">ğŸ—‘ï¸ æ¸…ç©ºåˆ—è¡¨</button>
            </div>
            <div id="articles-container" class="articles-grid">
                <!-- æ–‡ç« åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- ç»“æœæ˜¾ç¤º -->
        <div class="card" id="resultCard" style="display: none;">
            <h2>ğŸ“‹ å¤„ç†ç»“æœ</h2>
            <div id="resultContent" class="result-box"></div>
        </div>
    </div>

    <!-- é€šçŸ¥ -->
    <div id="notification" class="notification"></div>

    <script>
        // å…¨å±€å˜é‡
        let articles = JSON.parse(localStorage.getItem('medium-articles') || '[]');
        let currentFile = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            initializeEventListeners();
            initMediumConfig();
            loadArticles();
            enableBatchPublish();
            showNotification('é™æ€ç‰ˆæœ¬åŠ è½½å®Œæˆï¼Œå¯ä»¥ç¦»çº¿ä½¿ç”¨ï¼', 'success');
        });

        // äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            // æ–‡ç« è¡¨å•æäº¤
            document.getElementById('articleForm').addEventListener('submit', handleArticleSubmit);

            // æ–‡ä»¶ä¸Šä¼ 
            const fileUpload = document.getElementById('fileUpload');
            const fileInput = document.getElementById('fileInput');

            fileUpload.addEventListener('click', () => fileInput.click());
            fileUpload.addEventListener('dragover', handleDragOver);
            fileUpload.addEventListener('drop', handleFileDrop);
            fileInput.addEventListener('change', handleFileSelect);
        }

        // æ–‡ç« è¡¨å•æäº¤
        function handleArticleSubmit(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const article = {
                id: Date.now().toString(),
                title: formData.get('title'),
                subtitle: formData.get('subtitle'),
                content: formData.get('content'),
                tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag),
                createdAt: new Date().toISOString(),
                status: 'saved'
            };

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            articles.unshift(article);
            localStorage.setItem('medium-articles', JSON.stringify(articles));

            showNotification('æ–‡ç« å·²ä¿å­˜åˆ°æœ¬åœ°ï¼', 'success');
            e.target.reset();
            loadArticles();
        }

        // æ–‡ä»¶æ‹–æ‹½å¤„ç†
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        }

        function handleFile(file) {
            if (!file.name.match(/\.(csv|xlsx)$/i)) {
                showNotification('è¯·é€‰æ‹© CSV æˆ– Excel æ–‡ä»¶', 'error');
                return;
            }

            currentFile = file;
            document.getElementById('processBtn').disabled = false;
            document.getElementById('uploadBtn').disabled = false;

            const fileUpload = document.getElementById('fileUpload');
            fileUpload.innerHTML = `
                <div>
                    <p>âœ… å·²é€‰æ‹©æ–‡ä»¶: ${file.name}</p>
                    <p style="color: #666; font-size: 14px;">
                        æ–‡ä»¶å¤§å°: ${(file.size / 1024).toFixed(1)} KB
                    </p>
                    <button type="button" class="btn btn-secondary" onclick="clearFile()">
                        æ›´æ¢æ–‡ä»¶
                    </button>
                </div>
            `;
        }

        function clearFile() {
            currentFile = null;
            document.getElementById('processBtn').disabled = true;
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('fileUpload').innerHTML = `
                <div>
                    <p>ğŸ“„ æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
                    <p style="color: #666; font-size: 14px; margin-top: 10px;">
                        æ”¯æŒ CSV, Excel (.xlsx) æ ¼å¼
                    </p>
                </div>
            `;
        }

        // ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
        async function uploadToServer() {
            if (!currentFile) return;

            const btn = document.getElementById('uploadBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> ä¸Šä¼ ä¸­...';

            try {
                const formData = new FormData();
                formData.append('table', currentFile); // ä½¿ç”¨'table'å­—æ®µåï¼Œä¸APIåŒ¹é…
                formData.append('enhanceWithAI', document.getElementById('enhanceAI')?.checked || false);

                console.log('å¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨:', currentFile.name);

                console.log('å‘é€ä¸Šä¼ è¯·æ±‚...');
                const response = await fetch('/api/batch-upload', {
                    method: 'POST',
                    body: formData
                });

                console.log('æ”¶åˆ°æœåŠ¡å™¨å“åº”:', response.status);

                // è·å–å“åº”æ–‡æœ¬ï¼Œä¸ç®¡æˆåŠŸè¿˜æ˜¯å¤±è´¥
                const responseText = await response.text();
                console.log('å“åº”å†…å®¹:', responseText);

                if (!response.ok) {
                    console.error('ä¸Šä¼ å¤±è´¥:', response.status, responseText);
                    throw new Error(`æœåŠ¡å™¨é”™è¯¯ (${response.status}): ${responseText}`);
                }

                // è§£æJSONå“åº”
                let result;
                try {
                    result = JSON.parse(responseText);
                    console.log('è§£æåçš„å“åº”:', result);
                } catch (parseError) {
                    console.error('JSONè§£æé”™è¯¯:', parseError);
                    throw new Error('æ— æ³•è§£ææœåŠ¡å™¨å“åº”: ' + responseText);
                }

                if (result.success) {
                    showNotification(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${currentFile.name}`, 'success');
                    showResult(`ä¸Šä¼ æˆåŠŸ! æ–‡ä»¶: ${currentFile.name}\n\n${JSON.stringify(result.data, null, 2)}`);
                    clearFile();
                } else {
                    throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥ï¼ŒæœåŠ¡å™¨æœªè¿”å›é”™è¯¯è¯¦æƒ…');
                }
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                showNotification('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // å¤„ç†æ–‡ä»¶
        function processFile() {
            if (!currentFile) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    // æ˜¾ç¤ºåŸå§‹æ–‡ä»¶å†…å®¹ä»¥ä¾¿è°ƒè¯•
                    console.log('æ–‡ä»¶å†…å®¹:', e.target.result.substring(0, 500) + '...');

                    let data;
                    if (currentFile.name.endsWith('.csv')) {
                        // æ£€æµ‹æ–‡ä»¶ç¼–ç 
                        const encoding = detectEncoding(e.target.result);
                        console.log('æ£€æµ‹åˆ°æ–‡ä»¶ç¼–ç :', encoding);

                        data = parseCSV(e.target.result);
                        console.log('è§£æåçš„æ•°æ®:', data.slice(0, 2));
                    } else {
                        showNotification('Excelæ–‡ä»¶éœ€è¦ä¸“é—¨çš„è§£æåº“ï¼Œè¯·ä½¿ç”¨CSVæ ¼å¼', 'error');
                        return;
                    }

                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šæ ¼å¼çš„å†…å®¹åº“æ–‡ä»¶
                    // è·å–æ•°æ®ä¸­çš„æ ‡é¢˜è¡Œ
                    const headers = Object.keys(data[0] || {});
                    const isContentLibraryFile =
                        headers.includes('ä¸»é¢˜') &&
                        headers.includes('å‘å¸ƒ') &&
                        headers.includes('æå‡ºäºº') &&
                        headers.includes('å‘å¸ƒå†…å®¹');

                    console.log('æ˜¯å¦ä¸ºå†…å®¹åº“æ ¼å¼:', isContentLibraryFile);
                    console.log('æ£€æµ‹åˆ°çš„æ ‡é¢˜:', headers);

                    // è½¬æ¢ä¸ºæ–‡ç« æ ¼å¼ï¼Œæ”¯æŒå¤šç§CSVæ ¼å¼
                    const importedArticles = data.map((row, index) => {
                        // å°è¯•è¯†åˆ«ä¸åŒçš„åˆ—åæ ¼å¼
                        let title, content, tagsField;

                        if (isContentLibraryFile) {
                            // ç‰¹æ®Šå¤„ç†å†…å®¹åº“æ ¼å¼
                            title = row['ä¸»é¢˜'] || `å¯¼å…¥æ–‡ç« ${index + 1}`;
                            content = row['å‘å¸ƒå†…å®¹'] || row['markdownæ ¼å¼æ–‡æœ¬'] || '';
                            tagsField = row['æ ‡ç­¾'] || '';

                            // è°ƒè¯•è¾“å‡º
                            console.log(`å¤„ç†ç¬¬${index + 1}è¡Œ:`, {
                                title: title.substring(0, 30) + '...',
                                contentLength: content.length,
                                tags: tagsField
                            });
                        } else {
                            // æ ‡å‡†æ ¼å¼å¤„ç†
                            title = row.title || row['æ ‡é¢˜'] || row['ä¸»é¢˜'] || `å¯¼å…¥æ–‡ç« ${index + 1}`;
                            content = row.content || row['å†…å®¹'] || row['å‘å¸ƒå†…å®¹'] || row['markdownæ ¼å¼æ–‡æœ¬'] || '';
                            tagsField = row.tags || row['æ ‡ç­¾'] || '';
                        }

                        const subtitle = row.subtitle || row['å‰¯æ ‡é¢˜'] || '';

                        return {
                            id: Date.now() + index,
                            title: title,
                            subtitle: subtitle,
                            content: content,
                            tags: tagsField ? tagsField.split(/[,ï¼Œ]/).map(tag => tag.trim()).filter(tag => tag) : [],
                            createdAt: new Date().toISOString(),
                            status: 'imported'
                        };
                    });

                    // æ·»åŠ åˆ°æ–‡ç« åˆ—è¡¨
                    articles = [...importedArticles, ...articles];
                    localStorage.setItem('medium-articles', JSON.stringify(articles));

                    showNotification(`æˆåŠŸå¯¼å…¥ ${importedArticles.length} ç¯‡æ–‡ç« ï¼`, 'success');
                    loadArticles();
                    clearFile();

                    // å¯ç”¨æ‰¹é‡å‘å¸ƒæŒ‰é’®
                    enableBatchPublish();

                    // æ˜¾ç¤ºç»“æœ
                    showResult(`æˆåŠŸå¯¼å…¥ ${importedArticles.length} ç¯‡æ–‡ç« ï¼š\n\n${importedArticles.map(a => `- ${a.title}`).join('\n')}`);

                } catch (error) {
                    console.error('æ–‡ä»¶è§£æé”™è¯¯:', error);
                    // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                    showNotification('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message + 'ã€‚è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œæˆ–å°è¯•å¦å­˜ä¸ºUTF-8ç¼–ç çš„CSVæ–‡ä»¶ã€‚', 'error');

                    // å°è¯•æ˜¾ç¤ºéƒ¨åˆ†æ–‡ä»¶å†…å®¹ä»¥ä¾¿è°ƒè¯•
                    try {
                        const content = e.target.result.substring(0, 200);
                        showResult(`è§£æå¤±è´¥ã€‚æ–‡ä»¶å‰200ä¸ªå­—ç¬¦:\n${content}`);
                    } catch (e) {
                        showResult('æ— æ³•æ˜¾ç¤ºæ–‡ä»¶å†…å®¹');
                    }
                }
            };

            // å°è¯•ä½¿ç”¨ä¸åŒçš„ç¼–ç è¯»å–æ–‡ä»¶
            try {
                // é¦–å…ˆå°è¯•ä½¿ç”¨UTF-8è¯»å–
                reader.readAsText(currentFile, 'UTF-8');
            } catch (e) {
                console.error('UTF-8è¯»å–å¤±è´¥ï¼Œå°è¯•å…¶ä»–ç¼–ç ', e);
                try {
                    // å¦‚æœå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨GBK/GB18030è¯»å–ï¼ˆå¸¸è§ä¸­æ–‡ç¼–ç ï¼‰
                    reader.readAsText(currentFile, 'GBK');
                } catch (e2) {
                    // æœ€åå›é€€åˆ°é»˜è®¤ç¼–ç 
                    reader.readAsText(currentFile);
                }
            }
        }

        // æ£€æµ‹æ–‡æœ¬ç¼–ç 
        function detectEncoding(text) {
            // æ£€æŸ¥æ˜¯å¦æœ‰BOMæ ‡è®°
            if (text.charCodeAt(0) === 0xFEFF) {
                return 'UTF-8 with BOM';
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰å¸¸è§çš„ä¸­æ–‡å­—ç¬¦
            const hasChineseChars = /[\u4E00-\u9FFF]/.test(text);

            // æ£€æŸ¥æ˜¯å¦æœ‰å¯èƒ½çš„ç¼–ç é—®é¢˜ï¼ˆä¹±ç ç‰¹å¾ï¼‰
            const hasPossibleEncodingIssues = /[\uFFFD\u0000-\u0008\u000B-\u000C\u000E-\u001F]/.test(text);

            if (hasChineseChars && !hasPossibleEncodingIssues) {
                return 'UTF-8 (æ­£å¸¸)';
            } else if (hasChineseChars && hasPossibleEncodingIssues) {
                return 'å¯èƒ½å­˜åœ¨ç¼–ç é—®é¢˜';
            } else {
                return 'ASCIIæˆ–å…¶ä»–ç¼–ç ';
            }
        }

        // è¶…çº§å¢å¼ºç‰ˆCSVè§£æå™¨ï¼Œæ”¯æŒå„ç§æ ¼å¼å’Œç¼–ç é—®é¢˜
        function parseCSV(csvText) {
            console.log('å¼€å§‹è§£æCSV...');

            // å¤„ç†å¯èƒ½çš„BOM
            if (csvText.charCodeAt(0) === 0xFEFF) {
                csvText = csvText.slice(1);
            }

            // å¤„ç†ä¸åŒçš„è¡Œç»“æŸç¬¦
            csvText = csvText.replace(/\r\n|\r/g, '\n');

            const lines = csvText.split('\n').filter(line => line.trim());
            console.log(`CSVå…±æœ‰ ${lines.length} è¡Œæ•°æ®`);

            if (lines.length < 1) throw new Error('CSVæ–‡ä»¶ä¸ºç©º');

            // å°è¯•æ£€æµ‹åˆ†éš”ç¬¦
            const firstLine = lines[0];
            let separator = ',';
            const commaCount = (firstLine.match(/,/g) || []).length;
            const tabCount = (firstLine.match(/\t/g) || []).length;
            const semicolonCount = (firstLine.match(/;/g) || []).length;

            if (tabCount > commaCount && tabCount > semicolonCount) {
                separator = '\t';
                console.log('æ£€æµ‹åˆ°åˆ¶è¡¨ç¬¦åˆ†éš”çš„CSV');
            } else if (semicolonCount > commaCount && semicolonCount > tabCount) {
                separator = ';';
                console.log('æ£€æµ‹åˆ°åˆ†å·åˆ†éš”çš„CSV');
            } else {
                console.log('ä½¿ç”¨é»˜è®¤é€—å·åˆ†éš”ç¬¦');
            }

            // è¶…çº§è§£æCSVè¡Œï¼Œå¤„ç†å„ç§è¾¹ç¼˜æƒ…å†µ
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                let lastNonSpaceChar = '';

                // å¤„ç†ç©ºè¡Œ
                if (!line.trim()) {
                    return [];
                }

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            // è½¬ä¹‰çš„å¼•å·
                            current += '"';
                            i++; // è·³è¿‡ä¸‹ä¸€ä¸ªå¼•å·
                        } else if (inQuotes && (nextChar === separator || nextChar === undefined || nextChar === '\r' || nextChar === '\n')) {
                            // å¼•å·ç»“æŸï¼Œåé¢æ˜¯åˆ†éš”ç¬¦æˆ–è¡Œå°¾
                            inQuotes = false;
                        } else if (!inQuotes && (lastNonSpaceChar === '' || lastNonSpaceChar === separator)) {
                            // å¼•å·å¼€å§‹ï¼Œå‰é¢æ˜¯è¡Œé¦–æˆ–åˆ†éš”ç¬¦
                            inQuotes = true;
                        } else {
                            // å­—æ®µä¸­çš„å¼•å·
                            current += char;
                        }
                    } else if ((char === separator) && !inQuotes) {
                        // å­—æ®µåˆ†éš”ç¬¦
                        result.push(current.trim());
                        current = '';
                        lastNonSpaceChar = separator;
                    } else {
                        current += char;
                        if (char.trim() !== '') {
                            lastNonSpaceChar = char;
                        }
                    }
                }

                // æ·»åŠ æœ€åä¸€ä¸ªå­—æ®µ
                result.push(current.trim());

                return result;
            }

            const headers = parseCSVLine(lines[0]);
            console.log('è¯†åˆ«åˆ°çš„æ ‡é¢˜è¡Œ:', headers);
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue; // è·³è¿‡ç©ºè¡Œ

                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }

            return data;
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // ä¸‹è½½æ¨¡æ¿
        function downloadTemplate(format) {
            const csvContent = `ä¸»é¢˜,å‰¯æ ‡é¢˜,å‘å¸ƒå†…å®¹,æ ‡ç­¾
"ç¤ºä¾‹æ–‡ç« æ ‡é¢˜","ç¤ºä¾‹å‰¯æ ‡é¢˜","è¿™æ˜¯æ–‡ç« å†…å®¹...","æŠ€æœ¯,ç¼–ç¨‹,è‡ªåŠ¨åŒ–"
"ç¬¬äºŒç¯‡æ–‡ç« ","å‰¯æ ‡é¢˜2","æ›´å¤šå†…å®¹...","æ•™ç¨‹,æŒ‡å—"`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `medium_articles_template.${format}`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification(`${format.toUpperCase()} æ¨¡æ¿ä¸‹è½½å®Œæˆ`, 'success');
        }

        // åŠ è½½æ–‡ç« åˆ—è¡¨
        function loadArticles() {
            const container = document.getElementById('articles-container');

            if (articles.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— æ–‡ç« ï¼Œåˆ›å»ºæ‚¨çš„ç¬¬ä¸€ç¯‡æ–‡ç« å§ï¼</p>';
                return;
            }

            container.innerHTML = articles.map(article => `
                <div class="article-card">
                    <div style="font-weight: 600; margin-bottom: 10px;">${article.title}</div>
                    <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                        çŠ¶æ€: ${getStatusText(article.status)} | 
                        åˆ›å»º: ${new Date(article.createdAt).toLocaleString()}
                    </div>
                    <div style="font-size: 14px; margin-bottom: 15px;">
                        ${article.content.substring(0, 100)}${article.content.length > 100 ? '...' : ''}
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" style="width: auto; margin: 0;" onclick="editArticle('${article.id}')">
                            âœï¸ ç¼–è¾‘
                        </button>
                        <button class="btn btn-secondary" style="width: auto; margin: 0;" onclick="publishToMedium('${article.id}')">
                            ğŸš€ å‘å¸ƒåˆ°Medium
                        </button>
                        <button class="btn btn-secondary" style="width: auto; margin: 0;" onclick="exportSingle('${article.id}')">
                            ğŸ“¤ å¯¼å‡º
                        </button>
                        <button class="btn btn-secondary" style="width: auto; margin: 0;" onclick="deleteArticle('${article.id}')">
                            ğŸ—‘ï¸ åˆ é™¤
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'saved': 'å·²ä¿å­˜',
                'imported': 'å·²å¯¼å…¥',
                'exported': 'å·²å¯¼å‡º',
                'published': 'å·²å‘å¸ƒ'
            };
            return statusMap[status] || status;
        }

        // ç¼–è¾‘æ–‡ç« 
        function editArticle(articleId) {
            const article = articles.find(a => a.id == articleId);
            if (!article) return;

            document.getElementById('title').value = article.title;
            document.getElementById('subtitle').value = article.subtitle;
            document.getElementById('content').value = article.content;
            document.getElementById('tags').value = article.tags.join(', ');

            // åˆ é™¤åŸæ–‡ç« 
            articles = articles.filter(a => a.id != articleId);
            localStorage.setItem('medium-articles', JSON.stringify(articles));
            loadArticles();

            showNotification('æ–‡ç« å·²åŠ è½½åˆ°ç¼–è¾‘å™¨', 'info');
        }

        // å¯¼å‡ºå•ç¯‡æ–‡ç« 
        function exportSingle(articleId) {
            const article = articles.find(a => a.id == articleId);
            if (!article) return;

            const content = formatForMedium(article);
            downloadText(content, `${article.title}.txt`);
            showNotification('æ–‡ç« å·²å¯¼å‡ºä¸ºMediumæ ¼å¼', 'success');
        }

        // åˆ é™¤æ–‡ç« 
        function deleteArticle(articleId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ')) return;

            articles = articles.filter(a => a.id != articleId);
            localStorage.setItem('medium-articles', JSON.stringify(articles));
            loadArticles();
            showNotification('æ–‡ç« å·²åˆ é™¤', 'success');
        }

        // å¯¼å‡ºæ‰€æœ‰æ–‡ç« 
        function exportAllArticles() {
            if (articles.length === 0) {
                showNotification('æ²¡æœ‰æ–‡ç« å¯å¯¼å‡º', 'error');
                return;
            }

            const allContent = articles.map(article => {
                return `${'='.repeat(50)}\næ ‡é¢˜: ${article.title}\n${'='.repeat(50)}\n\n${formatForMedium(article)}\n\n`;
            }).join('\n');

            downloadText(allContent, 'medium-articles-export.txt');
            showNotification(`å·²å¯¼å‡º ${articles.length} ç¯‡æ–‡ç« `, 'success');
        }

        // æ¸…ç©ºæ‰€æœ‰æ–‡ç« 
        function clearAllArticles() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ–‡ç« å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            articles = [];
            localStorage.setItem('medium-articles', JSON.stringify(articles));
            loadArticles();
            showNotification('æ‰€æœ‰æ–‡ç« å·²æ¸…ç©º', 'success');
        }

        // å¯¼å‡ºMediumæ ¼å¼
        function exportMediumFormat() {
            const title = document.getElementById('title').value;
            const subtitle = document.getElementById('subtitle').value;
            const content = document.getElementById('content').value;
            const tags = document.getElementById('tags').value;

            if (!title || !content) {
                showNotification('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹', 'error');
                return;
            }

            const article = { title, subtitle, content, tags: tags.split(',').map(t => t.trim()) };
            const formattedContent = formatForMedium(article);

            downloadText(formattedContent, `${title}.txt`);
            showNotification('Mediumæ ¼å¼æ–‡ä»¶å·²ä¸‹è½½', 'success');
        }

        // æ ¼å¼åŒ–ä¸ºMediumæ ¼å¼
        function formatForMedium(article) {
            let content = `# ${article.title}\n\n`;

            if (article.subtitle) {
                content += `## ${article.subtitle}\n\n`;
            }

            content += article.content;

            if (article.tags && article.tags.length > 0) {
                content += `\n\n---\n\n**æ ‡ç­¾**: ${article.tags.join(', ')}`;
            }

            return content;
        }

        // ä¸‹è½½æ–‡æœ¬æ–‡ä»¶
        function downloadText(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(content) {
            const resultCard = document.getElementById('resultCard');
            const resultContent = document.getElementById('resultContent');

            resultContent.textContent = content;
            resultCard.style.display = 'block';
            resultCard.scrollIntoView({ behavior: 'smooth' });
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ============== Medium å‘å¸ƒåŠŸèƒ½ ==============

        // é…ç½®ç®¡ç†
        let mediumConfig = {
            token: localStorage.getItem('medium-token') || '',
            publicationId: localStorage.getItem('medium-publication') || '',
            proxyUrl: localStorage.getItem('medium-proxy') || 'https://cors-anywhere.herokuapp.com/',
            mode: localStorage.getItem('medium-mode') || 'token' // token, proxy, extension
        };

        // åˆå§‹åŒ–é…ç½®
        function initMediumConfig() {
            document.getElementById('mediumToken').value = mediumConfig.token;
            document.getElementById('publicationId').value = mediumConfig.publicationId;
            document.getElementById('proxyUrl').value = mediumConfig.proxyUrl;
        }

        // ä¿å­˜é…ç½®
        function saveMediumConfig() {
            mediumConfig.token = document.getElementById('mediumToken').value;
            mediumConfig.publicationId = document.getElementById('publicationId').value;
            mediumConfig.proxyUrl = document.getElementById('proxyUrl').value;

            localStorage.setItem('medium-token', mediumConfig.token);
            localStorage.setItem('medium-publication', mediumConfig.publicationId);
            localStorage.setItem('medium-proxy', mediumConfig.proxyUrl);
            localStorage.setItem('medium-mode', mediumConfig.mode);
        }

        // åˆ‡æ¢é…ç½®æ ‡ç­¾
        function switchConfigTab(tabName) {
            document.querySelectorAll('#token-config, #proxy-config, #extension-config').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-config').classList.add('active');

            mediumConfig.mode = tabName;
            saveMediumConfig();
        }

        // æµ‹è¯•Mediumè¿æ¥
        async function testMediumConnection() {
            const token = document.getElementById('mediumToken').value;
            if (!token) {
                showNotification('è¯·è¾“å…¥ Medium Token', 'error');
                return;
            }

            try {
                const response = await fetch('https://api.medium.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showNotification(`è¿æ¥æˆåŠŸï¼ç”¨æˆ·: ${data.data.username}`, 'success');
                    saveMediumConfig();
                } else {
                    showNotification('TokenéªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥Tokenæ˜¯å¦æ­£ç¡®', 'error');
                }
            } catch (error) {
                showNotification('è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•ä»£ç†è¿æ¥
        async function testProxyConnection() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            if (!proxyUrl) {
                showNotification('è¯·è¾“å…¥ä»£ç†åœ°å€', 'error');
                return;
            }

            try {
                const testUrl = proxyUrl + 'https://api.medium.com/v1/me';
                const response = await fetch(testUrl);

                if (response.status === 401) {
                    showNotification('ä»£ç†è¿æ¥æ­£å¸¸ï¼ˆéœ€è¦TokenéªŒè¯ï¼‰', 'success');
                } else if (response.ok) {
                    showNotification('ä»£ç†è¿æ¥æˆåŠŸ', 'success');
                } else {
                    showNotification('ä»£ç†æµ‹è¯•å¤±è´¥', 'error');
                }
                saveMediumConfig();
            } catch (error) {
                showNotification('ä»£ç†è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¸‹è½½ç”¨æˆ·è„šæœ¬
        function downloadUserScript() {
            const userScript = `// ==UserScript==
// @name         Medium Auto Publisher Helper
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  Mediumè‡ªåŠ¨å‘å¸ƒè¾…åŠ©è„šæœ¬
// @author       æ‚¨
// @match        https://medium.com/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';
    
    // æš´éœ²Mediumå‘å¸ƒå‡½æ•°åˆ°å…¨å±€
    window.publishToMediumDirect = async function(article) {
        try {
            // è¿™é‡Œå®ç°ç›´æ¥å‘å¸ƒé€»è¾‘
            console.log('å‘å¸ƒæ–‡ç« :', article.title);
            return { success: true, url: 'https://medium.com/@username/article-url' };
        } catch (error) {
            return { success: false, error: error.message };
        }
    };
    
    console.log('Mediumå‘å¸ƒè¾…åŠ©è„šæœ¬å·²åŠ è½½');
})();`;

            downloadText(userScript, 'medium-publisher.user.js');
            showNotification('ç”¨æˆ·è„šæœ¬å·²ä¸‹è½½', 'success');
        }

        // å‘å¸ƒå•ç¯‡æ–‡ç« åˆ°Medium
        async function publishSingleArticle() {
            const title = document.getElementById('title').value;
            const subtitle = document.getElementById('subtitle').value;
            const content = document.getElementById('content').value;
            const tags = document.getElementById('tags').value;

            if (!title || !content) {
                showNotification('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹', 'error');
                return;
            }

            const article = {
                title,
                subtitle,
                content,
                tags: tags.split(',').map(t => t.trim()).filter(t => t)
            };

            await publishArticleToMedium(article);
        }

        // å‘å¸ƒå•ä¸ªæ–‡ç« ï¼ˆä»åˆ—è¡¨ï¼‰
        async function publishToMedium(articleId) {
            const article = articles.find(a => a.id == articleId);
            if (!article) return;

            await publishArticleToMedium(article);
        }

        // æ‰¹é‡å‘å¸ƒæ–‡ç« 
        async function batchPublishArticles() {
            if (articles.length === 0) {
                showNotification('æ²¡æœ‰æ–‡ç« å¯å‘å¸ƒ', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦å‘å¸ƒ ${articles.length} ç¯‡æ–‡ç« åˆ°Mediumå—ï¼Ÿ`)) {
                return;
            }

            const publishBtn = document.getElementById('batchPublishBtn');
            publishBtn.disabled = true;
            publishBtn.innerHTML = '<span class="loading"></span> å‘å¸ƒä¸­...';

            let successCount = 0;
            let failureCount = 0;
            const results = [];

            for (let i = 0; i < articles.length; i++) {
                const article = articles[i];
                showNotification(`æ­£åœ¨å‘å¸ƒ: ${article.title} (${i + 1}/${articles.length})`, 'info');

                try {
                    const result = await publishArticleToMedium(article, false);
                    if (result.success) {
                        successCount++;
                        results.push(`âœ… ${article.title}: ${result.url}`);

                        // æ›´æ–°æ–‡ç« çŠ¶æ€
                        article.status = 'published';
                        article.publishedUrl = result.url;
                        article.publishedAt = new Date().toISOString();
                    } else {
                        failureCount++;
                        results.push(`âŒ ${article.title}: ${result.error}`);
                    }
                } catch (error) {
                    failureCount++;
                    results.push(`âŒ ${article.title}: ${error.message}`);
                }

                // å‘å¸ƒé—´éš”ï¼Œé¿å…é¢‘ç‡é™åˆ¶
                if (i < articles.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }

            // ä¿å­˜æ›´æ–°åçš„æ–‡ç« åˆ—è¡¨
            localStorage.setItem('medium-articles', JSON.stringify(articles));
            loadArticles();

            // æ˜¾ç¤ºç»“æœ
            const resultText = `æ‰¹é‡å‘å¸ƒå®Œæˆï¼\næˆåŠŸ: ${successCount} ç¯‡\nå¤±è´¥: ${failureCount} ç¯‡\n\nè¯¦ç»†ç»“æœ:\n${results.join('\n')}`;
            showResult(resultText);
            showNotification(`æ‰¹é‡å‘å¸ƒå®Œæˆï¼æˆåŠŸ ${successCount} ç¯‡ï¼Œå¤±è´¥ ${failureCount} ç¯‡`, successCount > 0 ? 'success' : 'error');

            publishBtn.disabled = false;
            publishBtn.innerHTML = 'ğŸš€ æ‰¹é‡å‘å¸ƒåˆ°Medium';
        }

        // æ ¸å¿ƒå‘å¸ƒå‡½æ•°
        async function publishArticleToMedium(article, showNotifications = true) {
            saveMediumConfig(); // ç¡®ä¿é…ç½®æ˜¯æœ€æ–°çš„

            if (!mediumConfig.token && mediumConfig.mode === 'token') {
                if (showNotifications) showNotification('è¯·å…ˆé…ç½® Medium Token', 'error');
                return { success: false, error: 'Missing Medium Token' };
            }

            try {
                let result;

                switch (mediumConfig.mode) {
                    case 'token':
                        result = await publishViaAPI(article);
                        break;
                    case 'proxy':
                        result = await publishViaProxy(article);
                        break;
                    case 'extension':
                        result = await publishViaExtension(article);
                        break;
                    default:
                        throw new Error('æœªçŸ¥çš„å‘å¸ƒæ¨¡å¼');
                }

                if (result.success && showNotifications) {
                    showNotification(`æ–‡ç« å‘å¸ƒæˆåŠŸï¼`, 'success');
                }

                return result;

            } catch (error) {
                if (showNotifications) {
                    showNotification(`å‘å¸ƒå¤±è´¥: ${error.message}`, 'error');
                }
                return { success: false, error: error.message };
            }
        }

        // é€šè¿‡å®˜æ–¹APIå‘å¸ƒ
        async function publishViaAPI(article) {
            const authorId = await getMediumAuthorId();
            if (!authorId) {
                throw new Error('æ— æ³•è·å–ä½œè€…ID');
            }

            const endpoint = mediumConfig.publicationId
                ? `https://api.medium.com/v1/publications/${mediumConfig.publicationId}/posts`
                : `https://api.medium.com/v1/users/${authorId}/posts`;

            const payload = {
                title: article.title,
                content: formatContentForMedium(article),
                contentFormat: 'markdown',
                publishStatus: 'public',
                tags: article.tags || []
            };

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${mediumConfig.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${error}`);
            }

            const data = await response.json();
            return {
                success: true,
                url: data.data.url,
                id: data.data.id
            };
        }

        // é€šè¿‡CORSä»£ç†å‘å¸ƒ
        async function publishViaProxy(article) {
            const proxyEndpoint = mediumConfig.proxyUrl + 'https://api.medium.com/v1/me';

            // é¦–å…ˆè·å–ç”¨æˆ·ä¿¡æ¯
            const userResponse = await fetch(proxyEndpoint, {
                headers: {
                    'Authorization': `Bearer ${mediumConfig.token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!userResponse.ok) {
                throw new Error('ä»£ç†è®¤è¯å¤±è´¥');
            }

            const userData = await userResponse.json();
            const authorId = userData.data.id;

            // å‘å¸ƒæ–‡ç« 
            const publishEndpoint = mediumConfig.proxyUrl + `https://api.medium.com/v1/users/${authorId}/posts`;

            const payload = {
                title: article.title,
                content: formatContentForMedium(article),
                contentFormat: 'markdown',
                publishStatus: 'public',
                tags: article.tags || []
            };

            const response = await fetch(publishEndpoint, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${mediumConfig.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(`ä»£ç†å‘å¸ƒå¤±è´¥: ${response.status} - ${error}`);
            }

            const data = await response.json();
            return {
                success: true,
                url: data.data.url,
                id: data.data.id
            };
        }

        // é€šè¿‡æµè§ˆå™¨æ‰©å±•å‘å¸ƒ
        async function publishViaExtension(article) {
            if (typeof window.publishToMediumDirect === 'function') {
                return await window.publishToMediumDirect(article);
            } else {
                throw new Error('æµè§ˆå™¨æ‰©å±•æœªå®‰è£…æˆ–æœªæ­£ç¡®é…ç½®');
            }
        }

        // è·å–Mediumä½œè€…ID
        async function getMediumAuthorId() {
            try {
                const response = await fetch('https://api.medium.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${mediumConfig.token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.data.id;
                }
            } catch (error) {
                console.error('è·å–ä½œè€…IDå¤±è´¥:', error);
            }
            return null;
        }

        // æ ¼å¼åŒ–æ–‡ç« å†…å®¹ä¸ºMediumæ ¼å¼
        function formatContentForMedium(article) {
            let content = '';

            if (article.subtitle) {
                content += `## ${article.subtitle}\n\n`;
            }

            content += article.content;

            return content;
        }

        // å¯ç”¨æ‰¹é‡å‘å¸ƒæŒ‰é’®
        function enableBatchPublish() {
            const batchBtn = document.getElementById('batchPublishBtn');
            if (batchBtn && articles.length > 0) {
                batchBtn.disabled = false;
            }
        }

        // å®šæœŸä¿å­˜æé†’
        setInterval(() => {
            if (articles.length > 0) {
                console.log(`ğŸ“š æœ¬åœ°å·²ä¿å­˜ ${articles.length} ç¯‡æ–‡ç« `);
            }
        }, 30000);


    </script>
</body>

</html>